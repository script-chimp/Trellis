@page "/"
@using Trellis.Engine
@using Trellis.Core
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div style="display: flex; gap: 20px;">
    <div style="width: 300px; border-right: 1px solid #ccc; height: 100vh; overflow-y: auto;">
        <h3>Passages</h3>
        @foreach (var passage in _passages)
        {
            <div class="passage-group">
                <div @onclick="() => TogglePassage(passage.Id)"
                     style="cursor: pointer; font-weight: bold; background: #eee; padding: 5px; margin-bottom: 2px;">
                    @(IsExpanded(passage.Id) ? "▼" : "▶") @passage.Name
                </div>

                @if (IsExpanded(passage.Id))
                {
                    <div style="padding-left: 20px;">
                        @foreach (var step in passage.Steps)
                        {
                            <div @onclick="() => HandleSelectionChange(step)"
                                 style="cursor: pointer; color: blue; text-decoration: underline; @(_selectedItem == step ? "background: #ffffcc;" : "")">
                                Step: @step.Name
                            </div>

                            @foreach (var link in step.Links)
                            {
                                <div @onclick="() => HandleSelectionChange(link)"
                                     style="padding-left: 15px; cursor: pointer; font-size: 0.9em; @(_selectedItem == link ? "background: #ffffcc;" : "")">
                                    🔗 @link.Target
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        }
    </div>

    <div style="flex-grow: 1; padding: 20px;">
        @if (_selectedItem != null)
        {
            <h3>Details</h3>
            <pre>@System.Text.Json.JsonSerializer.Serialize(_selectedItem, new System.Text.Json.JsonSerializerOptions { WriteIndented = true })</pre>
        }
        else
        {
            <p>Select a step or link to view details.</p>
        }
    </div>
</div>

@code {
    object? _selectedItem;
    TrellisEngine Engine;
    List<Passage> _passages = new();
    HashSet<string> _expandedPassages = new(); // Tracks which IDs are open

    protected override void OnInitialized()
    {
        // Adjust path as needed for your environment
        Engine = new TrellisEngine("C:\\Users\\BrawnSwagger\\source\\repos\\Trellis\\ExampleTrellisGame\\gameData.json", "Twine");
        _passages = Engine.Passages().ToList();
    }

    private void TogglePassage(string id)
    {
        if (_expandedPassages.Contains(id))
            _expandedPassages.Remove(id);
        else
            _expandedPassages.Add(id);
    }

    private bool IsExpanded(string id) => _expandedPassages.Contains(id);

    private void HandleSelectionChange(object item)
    {
        _selectedItem = item;
    }
}